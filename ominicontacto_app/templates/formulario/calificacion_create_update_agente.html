<!--
Copyright (C) 2018 Freetech Solutions

This file is part of OMniLeads

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License version 3, as published by
the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see http://www.gnu.org/licenses/.

-->
{% extends "agente/frame/base_frame.html" %}
{% load static %}
{% load i18n %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/ext/jquery.growl.css' %}">
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/googlemap.css' %}">
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/formulario_contacto.css' %}">
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/auditoria.css' %}" >
{% endblock extra_css%}
{% block head_js %}
    <!-- Scripts -->
    <script type="text/javascript" src="{% static 'ominicontacto/JS/csrf.js' %}"></script>
    <script type="text/javascript" src="{% static 'ominicontacto/JS/ext/jquery.growl.js' %}"></script>
    <script src="{% static 'ominicontacto/JS/agente/formularioCalificacion.js' %}"></script>
    <script src="{% static 'ominicontacto/JS/agente/make_click2call.js' %}"></script>
    <script src="{% static 'ominicontacto/JS/agente/interaccionSitioExterno.js' %}"></script>
    <script src="{% static 'ominicontacto/JS/agente/revisionAuditoria.js' %}"></script>
{% endblock head_js %}

{% block content %}
<div class="container">
    <input class="hidden" value='{{ configuracion_sitio_externo|safe }}' id="configuracionSitioExterno">

    {% if call_data and call_data.Omlinroutename and campana.mostrar_nombre_ruta_entrante%}
        <h1>{{ call_data.Omlinroutename }}</h1>
    {% endif %}
    {% if campana.mostrar_nombre %}
        <h1>{{ campana.nombre }}</h1>
    {% endif %}

    {% if call_data and call_data.ics %}
        <div><b>{% trans "Nombre Contacto ICS:" %}</b> {{ call_data.nombre_contacto_ics }}</div>
        <div><b>{% trans "ID Contacto ICS:" %}</b> {{ call_data.id_contacto_ics }}</div>
        <br>
    {% endif %}
    {% if extra_client_data %}
    <h2>{% trans "Información de cliente extra:" %}</h2>
        {% for key, value in extra_client_data.items %}
        <div><b>{{ key }}:</b> {{ value }}</div>
        {% endfor %}
        <br>
    {% endif %}

    <form id="form_sitio_externo">
        <input id="submit_interaccion" type="hidden" name="" value="{% trans 'Interacción CRM' %}">
    </form>

    <form id="form-calificacion" action = "" method = "post">
        {% csrf_token %}
        {% if llamada_entrante %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="false" id="mostrarFormCalificacion" name="usuario_califica">
                <label class="form-check-label" for="mostrarFormCalificacion">
                    {% trans '¿Desea calificar al contacto?' %}
                </label>
            </div>
        {% endif %}
        <div class="row">
          <div class="col-md-8">
                {{ contacto_form.non_field_errors }}
                {% for hidden_field in contacto_form.hidden_fields %}
                  {{ hidden_field.errors }}
                  {{ hidden_field }}
                {% endfor %}
                {% if contacto_form.confirmar_duplicado in contacto_form.hidden_fields %}
                    {{ contacto_form.confirmar_duplicado }}
                {% else %}
                    {{ contacto_form.confirmar_duplicado.label_tag }}{{ contacto_form.confirmar_duplicado }}
                {% endif %}

<div class="row">
                {% for field in contacto_form %}
                    {% if field.name != "confirmar_duplicado" %}

		{% if field.name == 'DEUDA_TOTAL' or field.name == 'MONTO_PROMESA_PAGO' or field.name == 'AGREEMENTS_2' %}
		<div class="col-md-4" style="margin-top:3px;"></div>
                </div>
                <div class="row">
		<div class="col-md-12">
		<hr/>
		</div>		
		{% endif %}
		{% with 'DEMANDADO TIPO_PRODUCTO OBSERVACION' as names %}
		{% if field.name in names.split %}
                <div class="col-md-8" style="margin-top:3px;">
		{% else %}
		<div class="col-md-4" style="margin-top:3px;">
		{% endif %}
		{% endwith %}
                        <tr>
                            <th>{{ field.label_tag}}</th>
                            <th>{{ field.errors }}</th>
                            <td> {{ field }}
                            {% if contacto and field.name in campos_telefono and field.value %}
                                    <a class="btn btn-submit btn-outline-primary" href="javascript:;" onclick="makeClick2Call('{{ campana.id }}', '{{ campana.type }}', '{{ contacto.id }}', '{{ field.value }}', 'agendas');" name="click2call">{{ field.value }}</a>
                            {% endif %}
                            </td>
                        </tr>
    </div>
                    {% endif %}
                {% endfor %}
</div>
                <br>
                <button type="submit" id="id_guardar" class="btn btn-primary">
                    {% trans 'Guardar'  %}
                </button>
            </div>
            <div class="col-md-4">
                <div id="div_calif" {% if llamada_entrante %}class="hidden"{% endif %} data="toHide">
                    {{calificacion_form.as_table}}
                </div>
                    {% with auditoria=calificacion_form.instance.obtener_auditoria %}
                        {% if auditoria%}
                            <div class="calificacion_auditada">
                                <h2>{% trans 'Calificación Auditada'%}</h2>
                                <p><b>{% trans 'Resultado Auditoria: '%}</b>{{auditoria.get_resultado_display}}</p>
                                <p><b>{% trans 'Observaciones: '%}</b>{{auditoria.observaciones}}</p>
                                {% if auditoria.es_observada %}
                                <p>
                                    {% if auditoria.revisada %}
                                        <div id="toggle_revision" class="btn btn-primary btn-sm" onclick="toggleRevision({{ auditoria.id }})" revised="{{ auditoria.revisada }}">
                                            {% trans 'Revisada' %}
                                        </div>
                                    {% else %}
                                        <div id="toggle_revision" class="btn btn-warning btn-sm" onclick="toggleRevision({{ auditoria.id }})" revised="{{ auditoria.revisada }}">
                                            {% trans 'No revisada'  %}
                                        </div>
                                    {% endif %}
                                </p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endwith %}
                {% if campana.speech %}
                    <div>
                      <p><label>{% trans "Speech:" %}</label><textarea class="form-control" rows="38" cols="40" readonly>{{ campana.speech }}</textarea></p>
                    </div>
                {% endif %}
                {% if campana.campo_direccion %}    
                    <div class="mapouter">
                        <div class="gmap_canvas" id="map"></div>
                        <div id="infowindow-content">
                            <span id="place-name" class="title"></span><br />
                            <span id="place-address"></span>
                        </div>
                    </div>
                {% endif %}
                <div {% if llamada_entrante %}class="hidden"{% endif %} data="toHide">
                    {% if calificacion_form.historico_calificaciones %}
                        {% include 'historico_calificaciones.html' with calificaciones=calificacion_form.instance.history.all %}
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
    <input type="hidden" id="field_address" name="{{campana.campo_direccion}}" value="{{GOOGLE_MAPS_CENTER}}">
</div>
</div>
{% if campana.campo_direccion %}    
    <script src="{% static 'ominicontacto/JS/agente/googlemap.js' %}">
    </script>
    <script
    src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=initMap&libraries=places&v=weekly"
    async
    ></script>
{% endif %}
<!-- AQUI EMPIEZA LA MAGIA -->
<script>
//"Contacto con Tercero",
//"Tercero No Toma Recado", 
  var contacto = {
    // Listado de las calificaciones positivas
    "lista_positivo": [
      "Agenda",
      "Promesa de Pago",
      "Compromiso Renegociacion",
      "Compromiso Repactacion",
      "Compromiso de Gestion",
      "Ya pago",
      "Contacto con Deudor sin compromiso",
      "Gestión Comercial Titular con Compromiso",
      "Gestión Comercial Titular sin Compromiso",
      "Gestión Comercial Ya Pagó",
      "Pago No Posteado",
	  "Devolución llamado a solicitud Cliente",
	  "Renegociación cursada WEB/APP",
	  "Bajas de los Ingresos",
	  "Catástrofes Naturales",
	  "Desconoce Deuda",
	  "Desface Fecha Sueldo - Fecha EECC",
	  "No llega EECC",
	  "Imposibilidad por Salud",
	  "Estafa (Apertura fraudulenta)",
	  "Enfermedad Covid19",
	  "Fallecido",
	  "Fuera del País Permanente",
	  "Se niega a pagar",
	  "Contingencia Pais",
	  "Licencia",
	  "Asistencia Plan Familiar",
	  "Sin Sucursal de Pago Cerca",
	  "Asistencia Plan Individual",
	  "Cliente Rechaza Asistencia",
	  "Exceso de Endeudamiento",
	  "No Entrega Información",
	  "Simple olvido",
	  "Cesante",
	  "Compra de terceros",
	  "Problema en la venta"
    ],
    // Obtengo la lista de calificadores y la devuelvo en option pero en string
    "options": function(value) {
      var options = '';
      $("#id_opcion_calificacion option").each(function() {
        var selected = '';
        if($(this).val() === value){
          selected = 'selected';
        }
        options += '<option value="' + $(this).val() + '" ' + selected + '>' + $(this).text() + '</option>';
      });
      return options;
    },
    // Remplaso el input por un select
    "remplaceInput": function(name, required = '') {
      required = (required) ?  'required' : '';

      selectValue = $("#id_" + name).val();
      var select = '<select id="id_' + name + '" name="' + name + '" class="form-control" ' + required + '>%s</select>'.replace('%s', this.options(selectValue));
      $("#id_" + name).replaceWith(select);
      $("#id_" + name).parent();
      return $("#id_" + name);
    },
    // Comprobar si el select seleccionado es una calificacon positiva
    "comprobarSelectCalificacion": function(select) {
      var option = select.find('option:selected');

      for (i = 0; i < this.lista_positivo.length; i++) {
        if(this.lista_positivo[i] == option.text()){
          return true;
        }
      }
      return false;
    },
    // formateando la vista
    "formatView": function() {
      var label = $("label[for='id_opcion_calificacion']").text('Calificación TELEFONO:');
      $("label[for='id_contacto_form-CALIFICACION_TELEFONO_2']").text('Calificación TELEFONO2:');
      $("label[for='id_contacto_form-CALIFICACION_TELEFONO_3']").text('Calificación TELEFONO3:');
      $("label[for='id_contacto_form-CALIFICACION_TELEFONO_4']").text('Calificación TELEFONO4:');

      var calificacion = $('#id_opcion_calificacion').addClass('form-control');
      var div = $('<div class="col-md-4" style="margin-top:3px"></div>')
      div.append(label).append(calificacion);
      $('#id_contacto_form-telefono').parent().after(div);

      // Mueve de lugar
      e = $('#id_contacto_form-CALIFICACION_TELEFONO_2').parent();
      e.prev().insertAfter(e);
      e.prev().insertAfter(e);

      // Mueve de lugar
      e = $('#id_contacto_form-CALIFICACION_TELEFONO_3').parent();
      e.prev().insertAfter(e);

      div = $('#div_calif').parent().hide().prev();
      div.removeClass('col-md-8').addClass('col-md-12');
      div.find('.col-md-4').removeClass('col-md-4').addClass('col-md-3');
      div.find('.col-md-8').removeClass('col-md-8').addClass('col-md-9');
    },
    // Accion del select
    "onChangeSelect": function() {
      sessionSelect = sessionStorage.getItem('calificaciones')? JSON.parse(sessionStorage.getItem('calificaciones')) : {};
      $('select').change(function() {
        var telefono = $(this).parent().prev().find('input').val();
        var option = $(this).find('option:selected');
        var key = $(this).attr('id') + '_' + telefono;
        var id_opcion_calificacion = $('#id_opcion_calificacion');

        // if(option.text() === 'Agenda'){
        //   if($(this).attr('id') == id_opcion_calificacion.attr('id'))

        //   if(id_opcion_calificacion.attr('id') != $(this).attr('id')){
        //     id_opcion_calificacion.val($(this).val());
        //     id_opcion_calificacion.parent().prevAll().find('a').hide();
        //     id_opcion_calificacion.parent().next().nextAll().find('a').hide();
        //   }
        // }else{
        //     id_opcion_calificacion.parent().prevAll().find('a:hidden').show();
        //     id_opcion_calificacion.parent().next().nextAll().find('a:hidden').show();
        // }
        if(option.text() === 'Agenda'){
          $(this).parent().prev().prevAll().find('a').hide();
          $(this).parent().nextAll().find('a').hide();
        } else {
          $(this).parent().prev().prevAll().find('a:hidden').show();
          $(this).parent().nextAll().find('a:hidden').show();
        }

        // Guardando calificacion en la session del navegador
        sessionSelect[key] = option.val();
        sessionStorage.setItem('calificaciones', JSON.stringify(sessionSelect));

        // Compruebo que sea positivo
        if(contacto.comprobarSelectCalificacion($(this))) {
          $(this).parent().prevAll().find('select').prop('required', false).attr("style", "pointer-events: none; background-color: #e9ecef");
          $(this).parent().nextAll().find('select').prop('required', false).attr("style", "pointer-events: none; background-color: #e9ecef");
          return;
        }

        // Select anteriores
        var select = $(this).parent().prevAll('div').find('select');
        for(i=0; i <= select.length; i++){
          var inputPrev = $(select[i]).parent().prev().find('input');
          $(select[i]).prop('readonly', false).removeAttr('style').prop('required', (inputPrev.val()));
        }

        // Select siguientes
        var select = $(this).parent().nextAll('div').find('select');
        for(i=0; i <= select.length; i++){
          var inputPrev = $(select[i]).parent().prev().find('input');
          if(inputPrev.val()){
            $(select[i]).prop('readonly', false).removeAttr('style').prop('required', (inputPrev.val()));
          }
        }

        return;
      })
    },
    // Actualizando los select
    "refresh": function(){
      var sessionSelect = sessionStorage.getItem('calificaciones')? JSON.parse(sessionStorage.getItem('calificaciones')) : {};

      var select = [
        'id_opcion_calificacion',
        'id_contacto_form-CALIFICACION_TELEFONO_2',
        'id_contacto_form-CALIFICACION_TELEFONO_3',
        'id_contacto_form-CALIFICACION_TELEFONO_4'
      ];
      

      for(var i = 0; i <= select.length; i++) {
        var telefono = $('#' + select[i]).parent().prev().find('input').val();
        var key = select[i] + '_' + telefono;
        var id = sessionSelect[key];
        if(id != undefined){
          $("#" + select[i]).val(id).change();
        }
      }
    },
    "submit": function() {
      $('#form-calificacion').submit(function(e){
        // e.preventDefault(); 

        var option = $('select').find('option:selected');
        for(var i = 0; i <= option.length; i++) {
            if(option[i] && option[i].text === 'Agenda'){
              // Principal
              var id_contacto_form_telefono = $('#id_contacto_form-telefono');
              var id_contacto_form_calificacion = $('#id_opcion_calificacion');
              var telefono_principal = id_contacto_form_telefono.val();
              var calificacion_principal = id_contacto_form_calificacion.val();

              // Select
              var selectOrigin = $(option[i]).parent();
              var inputOrigin = selectOrigin.parent().prev().find('input');
              var telefono_agendado = inputOrigin.val();
              var calificacion_agendado = selectOrigin.val();

              if(id_contacto_form_calificacion.attr('id') != selectOrigin.attr('id')){
                id_contacto_form_telefono.val(telefono_agendado);
                id_contacto_form_calificacion.val(calificacion_agendado);

                selectOrigin.val(calificacion_principal);
                inputOrigin.val(telefono_principal);
              }
            }
        }

        sessionStorage.removeItem('calificaciones');
      });
    },
    // script inicial
    "init": function() {
      $('form').find('input').prop('readonly', true);

      // El telefono principal siempre es requerido
      $('#id_opcion_calificacion').prop('required', true);
      
      // Telefono principal
      var telf = $('#id_contacto_form-telefono').attr('readonly', true);
      $('#id_contacto_form-MONTO_PROMESA_PAGO').attr('readonly', false);
      $('#id_contacto_form-OBSERVACION').attr('readonly', false);
      // Telefono secundarios
      for(i = 2; i <= 4; i++) {
        var telf = $('#id_contacto_form-TELEFONO' + i);
        telf.attr('readonly', true);
        contacto.remplaceInput('contacto_form-CALIFICACION_TELEFONO_' + i, false).prop('required', telf.val() ? true : false);
        if(!telf.val()) {
          $('#id_contacto_form-CALIFICACION_TELEFONO_' + i)
          .attr("style", "pointer-events: none; background-color: #e9ecef")
          .prop('required', false)
          .prop('readonly', true)
          .val('');
        }
      }

      this.onChangeSelect();
      this.formatView();
      this.refresh();
      this.submit();
    }
  };
  contacto.init();
</script>

{% endblock content %}
